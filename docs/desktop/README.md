# Kairo Desktop Environment è®¾è®¡è§„èŒƒ

> Kairo OS æ¡Œé¢ç¯å¢ƒæ¶æ„è®¾è®¡ï¼Œå®ç°ä¼ ç»Ÿæ¡Œé¢ä½“éªŒä¸ Agent åŸç”Ÿæ¸²æŸ“çš„ç»Ÿä¸€ã€‚

**è§†è§‰è§„èŒƒåŸºå‡†ï¼š** æœ¬æ–‡æ¡£æ‰€æœ‰è§†è§‰è®¾è®¡éµå¾ª [Kairo è®¾è®¡ç³»ç»Ÿ](../kdp-windows/design-system.md)ï¼Œ
åŒ…æ‹¬è°ƒè‰²æ¿ã€æ’ç‰ˆã€é—´è·ã€åœ†è§’å’Œäº¤äº’çŠ¶æ€ã€‚ä¸‹æ–‡ä¸­çš„é¢œè‰²å€¼å‡å¼•ç”¨è®¾è®¡ç³»ç»Ÿ Tokenã€‚

## 1. è®¾è®¡ç›®æ ‡

- æä¾›ä¼ ç»Ÿæ¡Œé¢ä½“éªŒï¼šå£çº¸ã€ä»»åŠ¡æ ã€åº”ç”¨å¯åŠ¨å™¨ã€çª—å£ç®¡ç†
- å…¼å®¹ç°æœ‰ Wayland/X11 åº”ç”¨ï¼ˆChromiumã€foot ç­‰é€šè¿‡ xdg-shell / XWaylandï¼‰
- Agent é€šè¿‡ KDP åè®®æ¸²æŸ“çª—å£ï¼Œä¸ä¼ ç»Ÿçª—å£åœ¨åŒä¸€å·¥ä½œåŒºå…±å­˜
- é¢„è£…åº”ç”¨ï¼šç»ˆç«¯ã€æ–‡ä»¶ç®¡ç†å™¨ã€Kairo å“ç‰Œçª—å£ã€Chromium

## 2. æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å¯è§æ¡Œé¢                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Chromium  â”‚  â”‚ ç»ˆç«¯(KDP) â”‚  â”‚ æ–‡ä»¶(KDP) â”‚              â”‚
â”‚  â”‚ (xdg-shell)â”‚  â”‚          â”‚  â”‚          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              ä»»åŠ¡æ  (KDP, bottom å±‚)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              å£çº¸ (KDP, background å±‚)            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‰å±‚æ¶æ„:

Tier 1 â€” åˆæˆå™¨ (River + wlroots, Zig)
  åœºæ™¯å›¾å±‚çº§: background â†’ bottom â†’ wm â†’ top â†’ fullscreen â†’ overlay â†’ popups
  åè®®: wl_compositor, xdg_shell, layer_shell, river_window_manager_v1, kairo_display_v2

Tier 2 â€” çª—å£ç®¡ç†å™¨ (kairo-wm, Zig)
  è¿æ¥ river_window_manager_v1 åè®®
  ä¸º KDP çª—å£åˆ›å»º river_shell_surface_v1ï¼Œä¸ xdg çª—å£ç»Ÿä¸€ç®¡ç†
  å¸ƒå±€ç®—æ³•ã€ç„¦ç‚¹ç®¡ç†ã€é”®ç›˜ç»‘å®š

Tier 3 â€” å†…æ ¸ (TypeScript/Bun)
  WindowManager æ„å»º KDP UI æ ‘
  æ¡Œé¢ Shell çŠ¶æ€ç®¡ç†ï¼ˆé¢æ¿ã€å¯åŠ¨å™¨ã€å£çº¸ï¼‰
  åº”ç”¨æ³¨å†Œè¡¨ä¸å¯åŠ¨æµç¨‹
```

## 3. æ ¸å¿ƒé—®é¢˜ï¼šKDP ä¸ xdg-shell å…±å­˜

### 3.1 ç°çŠ¶

å½“å‰ KDP surface æ¸²æŸ“åœ¨åœºæ™¯å›¾çš„ `overlay` å±‚ï¼ˆ`KairoDisplay.zig` ç¬¬ 270 è¡Œï¼‰ï¼Œå¯¼è‡´ï¼š
- KDP çª—å£å§‹ç»ˆç½®é¡¶ï¼Œæ— æ³•è¢«ä¼ ç»Ÿçª—å£é®æŒ¡
- çª—å£ç®¡ç†å™¨æ— æ³•ç®¡ç† KDP çª—å£çš„ä½ç½®å’Œå±‚å é¡ºåº
- KDP çª—å£ä¸ xdg-shell çª—å£æ— æ³•è‡ªç„¶äº¤äº’

### 3.2 è§£å†³æ–¹æ¡ˆï¼šKDP çª—å£ä½œä¸º river_shell_surface

River çš„ `river_window_manager_v1` åè®®æä¾›äº† `river_shell_surface_v1` æ¥å£ï¼Œå…è®¸ WM å®¢æˆ·ç«¯åˆ›å»ºä»»æ„ surface å¹¶å‚ä¸æ¸²æŸ“åˆ—è¡¨ã€‚è¿™æ˜¯ KDP çª—å£èå…¥æ¡Œé¢çš„æ­£ç¡®é›†æˆç‚¹ã€‚

**å·¥ä½œæµç¨‹ï¼š**

```
1. TypeScript å†…æ ¸è¯·æ±‚åˆ›å»º KDP çª—å£
       â†“ (IPC: window.create)
2. kairo-wm åˆ›å»º wl_surface + kairo_surface + river_shell_surface
       â†“
3. kairo-wm è·å¾— river_node_v1ï¼Œå¯æ§åˆ¶çª—å£åœ¨æ¸²æŸ“åˆ—è¡¨ä¸­çš„ä½ç½®
       â†“
4. TypeScript å†…æ ¸é€šè¿‡ kairo_surface.commit_ui_tree() æäº¤ UI æ ‘
       â†“
5. KairoDisplay.zig å°† UI æ ‘æ¸²æŸ“åˆ°è¯¥ surface çš„ scene tree
       â†“
6. çª—å£ä¸ xdg-shell çª—å£å…±äº«åŒä¸€å±‚çº§ï¼Œæ”¯æŒå±‚å ã€ç„¦ç‚¹åˆ‡æ¢
```

### 3.3 KDP åè®® v2 æ‰©å±•

åœ¨ `kairo_surface_v1` ä¸­æ–°å¢ä»¥ä¸‹è¯·æ±‚ï¼š

```xml
<!-- è®¾ç½® surface çš„ç›®æ ‡æ¸²æŸ“å±‚ -->
<request name="set_layer">
  <arg name="layer" type="uint" enum="layer"/>
</request>

<enum name="layer">
  <entry name="wm" value="0" summary="çª—å£ç®¡ç†å±‚ï¼ˆé»˜è®¤ï¼Œå‚ä¸ WM å¸ƒå±€ï¼‰"/>
  <entry name="overlay" value="1" summary="è¦†ç›–å±‚ï¼ˆå§‹ç»ˆç½®é¡¶ï¼Œå¦‚å¯åŠ¨å™¨ï¼‰"/>
  <entry name="background" value="2" summary="èƒŒæ™¯å±‚ï¼ˆå£çº¸ï¼‰"/>
  <entry name="bottom" value="3" summary="åº•éƒ¨å±‚ï¼ˆä»»åŠ¡æ ï¼‰"/>
</enum>

<!-- è®¾ç½® surface å‡ ä½•ä¿¡æ¯ -->
<request name="set_geometry">
  <arg name="x" type="int"/>
  <arg name="y" type="int"/>
  <arg name="width" type="int"/>
  <arg name="height" type="int"/>
</request>

<!-- è®¾ç½®çª—å£æ ‡é¢˜ï¼ˆç”¨äºä»»åŠ¡æ æ˜¾ç¤ºï¼‰ -->
<request name="set_title">
  <arg name="title" type="string"/>
</request>

<!-- åˆæˆå™¨è¯·æ±‚å…³é—­çª—å£ -->
<event name="request_close">
  <description summary="åˆæˆå™¨è¯·æ±‚å®¢æˆ·ç«¯å…³é—­æ­¤ surface"/>
</event>
```

### 3.4 KairoDisplay.zig ä¿®æ”¹

```
å½“å‰: æ‰€æœ‰ KDP surface â†’ scene.layers.overlay
ä¿®æ”¹å:
  layer=wm         â†’ åˆ›å»ºç‹¬ç«‹ scene treeï¼Œç”± WM é€šè¿‡ river_node_v1 å®šä½
  layer=overlay     â†’ scene.layers.overlayï¼ˆå¯åŠ¨å™¨ç­‰ä¸´æ—¶è¦†ç›–ï¼‰
  layer=background  â†’ scene.layers.backgroundï¼ˆå£çº¸ï¼‰
  layer=bottom      â†’ scene.layers.bottomï¼ˆä»»åŠ¡æ ï¼‰
```

è¾“å…¥è·¯ç”±ï¼šWM é€šè¿‡ `river_seat_v1.focus_shell_surface` å°†ç„¦ç‚¹åˆ‡æ¢åˆ° KDP çª—å£ï¼ŒKDP çš„ `key_event`ã€`pointer_event`ã€`focus_event` æ­£å¸¸å·¥ä½œã€‚

## 4. æ¡Œé¢ Shell ç»„ä»¶

### 4.1 å£çº¸

**æ¸²æŸ“å±‚ï¼š** background
**å®ç°ï¼š** KDP surfaceï¼Œ`set_layer(background)`

åˆå§‹é˜¶æ®µä½¿ç”¨çº¯è‰²æ¸å˜ï¼Œé¢œè‰²åŸºäºè®¾è®¡ç³»ç»Ÿ Base è‰²ï¼ˆ`#0D0D12`ï¼‰ï¼š

```json
{
  "type": "root",
  "children": [
    {
      "type": "rect", "id": "wallpaper-base",
      "x": 0, "y": 0, "width": 1280, "height": 720,
      "color": [0.051, 0.051, 0.071, 1.0]
    },
    {
      "type": "rect", "id": "wallpaper-glow",
      "x": 440, "y": 260, "width": 400, "height": 200,
      "color": [0.29, 0.486, 1.0, 0.03],
      "radius": 200
    }
  ]
}
```

> å£çº¸åº•è‰²ä½¿ç”¨ Base `#0D0D12` â†’ `[0.051, 0.051, 0.071, 1.0]`ï¼Œ
> ä¸­å¿ƒå¾®å…‰ä½¿ç”¨ Kairo Blue `#4A7CFF` 3% é€æ˜åº¦ï¼Œè¥é€ ã€Œé™è°§ç§‘æŠ€æ„Ÿã€ã€‚

åç»­é˜¶æ®µï¼šå®Œå–„ KDP `image` èŠ‚ç‚¹å®ç°ï¼Œæ”¯æŒ PNG/JPG å£çº¸åŠ è½½ã€‚

Agent å¯åŠ¨æ€ä¿®æ”¹å£çº¸ï¼ˆå¦‚æ ¹æ®æ—¶é—´ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ã€‚

### 4.2 ä»»åŠ¡æ  (Panel)

**æ¸²æŸ“å±‚ï¼š** bottom
**é«˜åº¦ï¼š** 36pxï¼ˆä¸è®¾è®¡ç³»ç»Ÿçª—å£æ ‡é¢˜æ é«˜åº¦ä¸€è‡´ï¼‰ï¼Œé”šå®šå±å¹•åº•éƒ¨
**èƒŒæ™¯è‰²ï¼š** Surface `#16161E` â†’ `[0.086, 0.086, 0.118, 0.95]`
**é¡¶éƒ¨è¾¹æ¡†ï¼š** Border `#2A2A3C` â†’ `[0.165, 0.165, 0.235, 0.5]`ï¼Œ1px
**å®ç°ï¼š** KDP surfaceï¼Œ`set_layer(bottom)`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—‡ Kairo â”‚  ç»ˆç«¯  â”‚  æ–‡ä»¶  â”‚  Chromium  â”‚        â”‚ â— Agent â”‚ 14:30 â”‚
â”‚ [å¯åŠ¨å™¨] â”‚ [æ´»åŠ¨çª—å£åˆ—è¡¨]                â”‚        â”‚ [çŠ¶æ€]  â”‚ [æ—¶é’Ÿ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  å·¦ä¾§        ä¸­é—´                                    å³ä¾§
```

**å·¦ä¾§åŒºåŸŸï¼š**
- Kairo Logo æŒ‰é’®ï¼ˆâ—‡ï¼‰ï¼ŒKairo Blue `#4A7CFF`
- ç‚¹å‡»æ‰“å¼€åº”ç”¨å¯åŠ¨å™¨
- hover æ€ï¼šèƒŒæ™¯æäº®ä¸€çº§ï¼ˆ+0.04 äº®åº¦ï¼Œéµå¾ªè®¾è®¡ç³»ç»Ÿäº¤äº’çŠ¶æ€ï¼‰

**ä¸­é—´åŒºåŸŸï¼š**
- æ´»åŠ¨çª—å£åˆ—è¡¨ï¼Œæ¯ä¸ªæ¡ç›®æ˜¾ç¤ºåº”ç”¨å›¾æ ‡ + æ ‡é¢˜
- æ–‡å­—ä½¿ç”¨ Body 14pxï¼Œé¢œè‰² Secondary `#8E8E9A`
- å½“å‰ç„¦ç‚¹çª—å£ï¼šæ–‡å­— Primary `#E8E8ED`ï¼Œåº•éƒ¨ 2px Kairo Blue ä¸‹åˆ’çº¿
- hover æ€ï¼šèƒŒæ™¯ Elevated `#1E1E2A`
- ç‚¹å‡»åˆ‡æ¢ç„¦ç‚¹ï¼Œå³é”®å…³é—­

**å³ä¾§åŒºåŸŸï¼š**
- Agent çŠ¶æ€æŒ‡ç¤ºå™¨ï¼šâ— Success `#34C759`ï¼ˆæ´»è·ƒï¼‰ï¼ŒSecondary `#8E8E9A`ï¼ˆç©ºé—²ï¼‰
- ç³»ç»Ÿæ—¶é’Ÿï¼šCaption 12pxï¼ŒSecondary è‰²ï¼ŒHH:MM æ ¼å¼
- å…ƒç´ é—´è·ï¼šsm 8px

**æ•°æ®æµï¼š**

```
kairo-wm æ£€æµ‹åˆ°çª—å£å˜åŒ–ï¼ˆxdg window äº‹ä»¶ / KDP çª—å£åˆ›å»ºï¼‰
    â†“ IPC: window.list.changed
TypeScript å†…æ ¸ WindowManager æ›´æ–°çª—å£åˆ—è¡¨
    â†“
Panel æ§åˆ¶å™¨é‡å»º UI æ ‘
    â†“ kairo_surface.commit_ui_tree()
åˆæˆå™¨æ¸²æŸ“æ›´æ–°åçš„é¢æ¿
```

**WM å¸ƒå±€è°ƒæ•´ï¼š**

kairo-wm çš„ `proposeDimensions` å’Œ `positionWindows` éœ€è¦é¢„ç•™é¢æ¿é«˜åº¦ï¼š

```
å¯ç”¨çª—å£åŒºåŸŸ = å±å¹•é«˜åº¦ - é¢æ¿é«˜åº¦(36px)
çª—å£ y åç§» = 0ï¼ˆé¢æ¿åœ¨åº•éƒ¨ï¼Œä¸å½±å“é¡¶éƒ¨èµ·å§‹ä½ç½®ï¼‰
```

### 4.3 åº”ç”¨å¯åŠ¨å™¨ (Launcher)

**æ¸²æŸ“å±‚ï¼š** overlayï¼ˆå§‹ç»ˆç½®é¡¶ï¼‰
**è§¦å‘ï¼š** Super é”® / ç‚¹å‡»é¢æ¿ Logo
**å°ºå¯¸ï¼š** 480Ã—520pxï¼Œå±å¹•å±…ä¸­
**èƒŒæ™¯è‰²ï¼š** Elevated `#1E1E2A` â†’ `[0.118, 0.118, 0.165, 0.92]`
**åœ†è§’ï¼š** lg 12pxï¼ˆè®¾è®¡ç³»ç»Ÿçª—å£/å¼¹çª—åœ†è§’ï¼‰
**è¾¹æ¡†ï¼š** Border `#2A2A3C` 1px

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† Elevated èƒŒæ™¯, 12px åœ†è§’
â”‚  ğŸ” æœç´¢åº”ç”¨...                [input]  â”‚  â† input èŠ‚ç‚¹, Body 14px
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â† Divider #1E1E2A
â”‚                                        â”‚
â”‚   â—‡ Kairo      >_ ç»ˆç«¯      [] æ–‡ä»¶    â”‚  â† 120Ã—96px å¡ç‰‡, md 8px åœ†è§’
â”‚                                        â”‚
â”‚   â—‹ Chromium                           â”‚
â”‚                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚  â† Caption 12px, Tertiary è‰²
â”‚                                        â”‚
â”‚   âš™ è®¾ç½®       â“˜ å…³äº                  â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åº”ç”¨å¡ç‰‡æ ·å¼ï¼š**
- å°ºå¯¸ï¼š120Ã—96px
- èƒŒæ™¯ï¼šSurface `#16161E`
- åœ†è§’ï¼šmd 8px
- å›¾æ ‡ï¼šDisplay 32pxï¼ŒKairo Blue
- åç§°ï¼šCaption 12pxï¼ŒSecondary è‰²
- hover æ€ï¼šèƒŒæ™¯æäº®è‡³ Overlay `#252536`
- active æ€ï¼šèƒŒæ™¯å‹æš—ï¼ˆ-0.02 äº®åº¦ï¼‰
- é—´è·ï¼šå¡ç‰‡é—´ lg 16pxï¼Œå†…è¾¹è· md 12px

**äº¤äº’ï¼š**
- è¾“å…¥æœç´¢æ–‡æœ¬è¿‡æ»¤åº”ç”¨åˆ—è¡¨
- ç‚¹å‡»åº”ç”¨å›¾æ ‡å¯åŠ¨
- æŒ‰ Escape æˆ–ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­
- Super é”®åˆ‡æ¢æ˜¾ç¤º/éšè—
- å¯åŠ¨å™¨æ‰“å¼€æ—¶ï¼ŒèƒŒæ™¯åŠé€æ˜é®ç½© Base `#0D0D12` 50% é€æ˜åº¦

**é”®ç›˜ç»‘å®šï¼š**

é€šè¿‡ `river_xkb_bindings_v1` åè®®æ³¨å†Œ Super é”®ç»‘å®šã€‚kairo-wm æ‹¦æˆª Super é”®æŒ‰ä¸‹äº‹ä»¶ï¼Œé€šè¿‡ IPC é€šçŸ¥å†…æ ¸åˆ‡æ¢å¯åŠ¨å™¨çŠ¶æ€ã€‚

## 5. çª—å£è£…é¥°

### 5.1 ä¼ ç»Ÿåº”ç”¨ (xdg-shell)

ä½¿ç”¨ River çš„æœåŠ¡ç«¯è£…é¥° (SSD)ï¼Œé¢œè‰²å¯¹é½è®¾è®¡ç³»ç»Ÿï¼š

```
kairo-wm å¯¹æ¯ä¸ª xdg çª—å£è°ƒç”¨:
  river_window.use_ssd()
  river_window.set_borders(
    active_color:   Kairo Blue  [0.29, 0.486, 1.0, 1.0]     (#4A7CFF)
    inactive_color: Surface     [0.086, 0.086, 0.118, 0.95]  (#16161E)
    border_width: 2
  )
```

å¯¹äºä»…æ”¯æŒ CSD çš„åº”ç”¨ï¼ˆå¦‚ Chromiumï¼‰ï¼Œé€šè¿‡ `decoration_hint` äº‹ä»¶æ£€æµ‹å¹¶å›é€€ã€‚

### 5.2 KDP çª—å£

KDP çª—å£çš„è£…é¥°æ˜¯ UI æ ‘çš„ä¸€éƒ¨åˆ†ï¼ˆæ ‡é¢˜æ ã€æ§åˆ¶æŒ‰é’®å·²åœ¨ç°æœ‰å®ç°ä¸­ï¼‰ã€‚ä¿æŒç°æœ‰çš„çª—å£æ¡†æ¶æ„å»ºå™¨ (`src/domains/ui/builders/window.ts`) ä¸å˜ã€‚

çª—å£æ§åˆ¶æŒ‰é’®éµå¾ªè®¾è®¡ç³»ç»Ÿè§„èŒƒï¼š
- å³ä¸Šè§’èƒ¶å›Šå¼æŒ‰é’®ç»„ï¼Œ16Ã—16pxï¼Œsm 4px åœ†è§’
- æ’åˆ—é¡ºåºï¼š[æœ€å°åŒ– â”€] [æœ€å¤§åŒ– â–¡] [å…³é—­ Ã—]
- é»˜è®¤ Secondary `#8E8E9A`ï¼Œhover Primary `#E8E8ED`
- å…³é—­æŒ‰é’® hover æ€ Error `#FF4D6A`

### 5.3 ç»Ÿä¸€è§†è§‰

æ‰€æœ‰é¢œè‰²å€¼å¼•ç”¨è®¾è®¡ç³»ç»Ÿ Tokenï¼Œç¡®ä¿ SSD å’Œ KDP çª—å£è§†è§‰ä¸€è‡´ï¼š

| å±æ€§ | ä¼ ç»Ÿåº”ç”¨ (SSD) | KDP çª—å£ | è®¾è®¡ç³»ç»Ÿ Token |
|------|---------------|---------|---------------|
| æ ‡é¢˜æ é«˜åº¦ | 30px (River SSD) | 36px (KDP UI æ ‘) | çª—å£æ ‡é¢˜æ  36px |
| æ´»è·ƒè¾¹æ¡† | 2px | 1px (UI æ ‘å†…) | Kairo Blue `#4A7CFF` |
| éæ´»è·ƒè¾¹æ¡† | 2px | æ—  | Surface `#16161E` |
| å…³é—­æŒ‰é’® hover | SSD å†…ç½® | Error è‰² | Error `#FF4D6A` |
| åœ†è§’ | æ—  (SSD é™åˆ¶) | 8px | md 8px |
| æ ‡é¢˜æ–‡å­— | â€” | Title 20px 600 | è®¾è®¡ç³»ç»Ÿæ’ç‰ˆ Title |

## 6. é¢„è£…åº”ç”¨ç®¡ç†

### 6.1 åº”ç”¨æ³¨å†Œè¡¨

æ–°å¢ `src/domains/ui/apps.ts`ï¼š

```typescript
interface AppEntry {
  id: string;
  name: string;          // æ˜¾ç¤ºåç§°
  icon: string;          // KDP æ–‡æœ¬å›¾æ ‡ï¼ˆä½å›¾å­—ä½“å­—ç¬¦ï¼‰
  type: 'native' | 'kdp'; // å¯åŠ¨æ–¹å¼
  command?: string;      // native ç±»å‹çš„å¯åŠ¨å‘½ä»¤
  category: string;      // åˆ†ç±»
}

const PREINSTALLED_APPS: AppEntry[] = [
  { id: 'brand',    name: 'Kairo',    icon: 'â—‡', type: 'kdp',    category: 'ç³»ç»Ÿ' },
  { id: 'terminal', name: 'ç»ˆç«¯',     icon: '>_', type: 'kdp',    category: 'ç³»ç»Ÿ' },
  { id: 'files',    name: 'æ–‡ä»¶',     icon: '[]', type: 'kdp',    category: 'ç³»ç»Ÿ' },
  { id: 'chromium', name: 'Chromium', icon: 'â—‹',  type: 'native',
    command: 'chromium-browser --no-sandbox --ozone-platform=wayland', category: 'åº”ç”¨' },
];
```

### 6.2 å¯åŠ¨æµç¨‹

**KDP åº”ç”¨ï¼š**

```
ç”¨æˆ·ç‚¹å‡»å¯åŠ¨å™¨ä¸­çš„ "ç»ˆç«¯"
    â†“
å†…æ ¸ WindowManager.createWindow('terminal')
    â†“
åˆ›å»º TerminalController å®ä¾‹
    â†“ IPC: window.create { id, title, width, height }
kairo-wm åˆ›å»º wl_surface + kairo_surface + river_shell_surface
    â†“
TerminalController æ„å»º UI æ ‘ â†’ commit_ui_tree()
    â†“
åˆæˆå™¨æ¸²æŸ“ï¼ŒWM å®šä½çª—å£
```

**Native åº”ç”¨ï¼š**

```
ç”¨æˆ·ç‚¹å‡»å¯åŠ¨å™¨ä¸­çš„ "Chromium"
    â†“
å†…æ ¸ ProcessManager.spawn('chromium-browser --no-sandbox --ozone-platform=wayland')
    â†“
Chromium è¿æ¥ Waylandï¼Œåˆ›å»º xdg_toplevel
    â†“
River é€šçŸ¥ kairo-wm: river_window_manager_v1.window äº‹ä»¶
    â†“
kairo-wm åº”ç”¨å¸ƒå±€ç®—æ³•ï¼Œå®šä½çª—å£
    â†“
é¢æ¿æ›´æ–°çª—å£åˆ—è¡¨
```

### 6.3 Chromium å®‰è£…

åœ¨ `os/Dockerfile` ä¸­æ·»åŠ ï¼š

```dockerfile
# æµè§ˆå™¨
apk add --no-cache chromium
```

åœ¨ `lima-kairo-river.yaml` çš„ provision è„šæœ¬ä¸­æ·»åŠ ï¼š

```bash
apk add --no-cache chromium
```

## 7. WM å¸ƒå±€å¢å¼º

### 7.1 å½“å‰å¸ƒå±€

```
Master/Stack:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚  Stack 1  â”‚
â”‚  Master  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚  Stack 2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ¡Œé¢å¸ƒå±€

```
å¸¦é¢æ¿çš„ Master/Stack:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚  Stack 1  â”‚
â”‚  Master  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚  Stack 2  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       é¢æ¿ (36px)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent æ¿€æ´»æ—¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚       â”‚Stack 1â”‚     â”‚
â”‚Master â”œâ”€â”€â”€â”€â”€â”€â”€â”¤Agentâ”‚
â”‚       â”‚Stack 2â”‚ 30% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚   é¢æ¿ (36px)  â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

### 7.3 çª—å£æ“ä½œ

| æ“ä½œ | å¿«æ·é”® | è¯´æ˜ |
|------|--------|------|
| åˆ‡æ¢ç„¦ç‚¹ | Alt+Tab | å¾ªç¯åˆ‡æ¢æ‰€æœ‰çª—å£ï¼ˆxdg + KDPï¼‰ |
| å…³é—­çª—å£ | Alt+F4 | å‘é€ close è¯·æ±‚ |
| å…¨å± | F11 | åˆ‡æ¢å…¨å±æ¨¡å¼ |
| å¯åŠ¨å™¨ | Super | æ‰“å¼€/å…³é—­åº”ç”¨å¯åŠ¨å™¨ |
| ç§»åŠ¨çª—å£ | Super+æ‹–æ‹½ | æ‹–æ‹½ç§»åŠ¨ï¼ˆä»…æµ®åŠ¨æ¨¡å¼ï¼‰ |

## 8. IPC åè®®æ‰©å±•

### 8.1 æ–°å¢ IPC æ–¹æ³•

```
window.create    â†’ { id, title, width, height, type }
window.close     â†’ { id }
window.focus     â†’ { id }
window.list      â†’ [{ id, title, app_id, focused }]
desktop.launcher.toggle â†’ {}
desktop.panel.update    â†’ { windows: [...] }
```

### 8.2 æ–°å¢ IPC äº‹ä»¶

```
EVENT window.list.changed  â†’ { windows: [...] }
EVENT window.focused       â†’ { id }
EVENT desktop.launcher.app.launch â†’ { app_id }
```

## 9. æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `os/src/shell/protocol/kairo-display-v1.xml` | æ–°å¢ set_layer, set_geometry, set_title, request_close |
| `os/src/shell/river/KairoDisplay.zig` | æ”¯æŒå¤šå±‚æ¸²æŸ“ï¼Œé»˜è®¤ wm å±‚ |
| `os/src/shell/river/build.zig` | åè®®ç‰ˆæœ¬ bump |
| `os/src/wm/main.zig` | é¢æ¿é«˜åº¦é¢„ç•™ã€KDP shell_surface ç®¡ç†ã€é”®ç›˜ç»‘å®š |
| `os/src/wm/ipc.zig` | æ–°å¢ window.create/close/list æ–¹æ³•å¤„ç† |
| `os/Dockerfile` | æ·»åŠ  chromium åŒ… |
| `lima-kairo-river.yaml` | æ·»åŠ  chromium åŒ… |
| `os/src/shell/config/init` | å¯åŠ¨æ¡Œé¢ç¯å¢ƒè€Œéè£¸ç»ˆç«¯ |
| `src/domains/ui/window-manager.ts` | çª—å£åˆ—è¡¨è¿½è¸ªã€é¢æ¿æ•°æ®æº |
| `src/domains/ui/compositor.plugin.ts` | æ¡Œé¢ Shell åˆå§‹åŒ– |
| `src/domains/ui/tokens.ts` | é¢æ¿/å¯åŠ¨å™¨ token |

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/domains/ui/windows/panel.ts` | ä»»åŠ¡æ  UI æ ‘æ„å»ºå™¨ + æ§åˆ¶å™¨ |
| `src/domains/ui/windows/launcher.ts` | åº”ç”¨å¯åŠ¨å™¨ UI æ ‘æ„å»ºå™¨ + æ§åˆ¶å™¨ |
| `src/domains/ui/windows/wallpaper.ts` | å£çº¸ surface æ§åˆ¶å™¨ |
| `src/domains/ui/apps.ts` | åº”ç”¨æ³¨å†Œè¡¨ + å¯åŠ¨é€»è¾‘ |

## 10. å®ç°é˜¶æ®µ

### Phase 1: KDP å±‚è¿ç§»ï¼ˆåŸºç¡€ï¼‰

å°† KDP æ¸²æŸ“ä» overlay è¿ç§»åˆ° wm å±‚ï¼Œè¿™æ˜¯æœ€å…³é”®çš„æ¶æ„å˜æ›´ã€‚

- æ‰©å±• `kairo-display-v1.xml` åè®®ï¼ˆset_layer, set_geometry, set_titleï¼‰
- ä¿®æ”¹ `KairoDisplay.zig` æ”¯æŒå¤šå±‚æ¸²æŸ“
- ä¿®æ”¹ `kairo-wm` ä¸º KDP çª—å£åˆ›å»º `river_shell_surface_v1`
- éªŒè¯ç°æœ‰ KDP çª—å£ï¼ˆå“ç‰Œã€ç»ˆç«¯ã€æ–‡ä»¶ç®¡ç†å™¨ï¼‰åœ¨ wm å±‚æ­£å¸¸å·¥ä½œ
- éªŒè¯è¾“å…¥è·¯ç”±ï¼šç„¦ç‚¹åˆ‡æ¢ã€é”®ç›˜äº‹ä»¶ã€é¼ æ ‡äº‹ä»¶

**é£é™©ç‚¹ï¼š** è¾“å…¥è·¯ç”±ã€‚KDP ä» overlay ç§»åˆ° wm å±‚åï¼Œéœ€è¦é€šè¿‡ `river_seat_v1.focus_shell_surface` æ­£ç¡®ç®¡ç†ç„¦ç‚¹ã€‚

### Phase 2: é¢æ¿ + å£çº¸

- åˆ›å»ºå£çº¸ surfaceï¼ˆçº¯è‰²æ¸å˜ï¼‰
- åˆ›å»ºé¢æ¿ surfaceï¼ˆ36px åº•éƒ¨æ ï¼‰
- ä¿®æ”¹ WM å¸ƒå±€é¢„ç•™é¢æ¿ç©ºé—´
- å®ç°çª—å£åˆ—è¡¨ï¼šWM é€šè¿‡ IPC å‘é€çª—å£äº‹ä»¶ï¼Œé¢æ¿æ§åˆ¶å™¨é‡å»º UI æ ‘
- å®ç°ç³»ç»Ÿæ—¶é’Ÿ

### Phase 3: çª—å£è£…é¥° + å±‚å ç®¡ç†

- WM å¯¹ xdg çª—å£è°ƒç”¨ `use_ssd` + `set_borders`
- å®ç° raise-on-clickï¼ˆxdg + KDP çª—å£ï¼‰
- å®ç° Alt+Tab çª—å£å¾ªç¯ï¼ˆé€šè¿‡ xkb_bindingsï¼‰
- é¢æ¿çª—å£åˆ—è¡¨ç‚¹å‡»åˆ‡æ¢ç„¦ç‚¹

### Phase 4: åº”ç”¨å¯åŠ¨å™¨ + é¢„è£…åº”ç”¨

- åˆ›å»ºå¯åŠ¨å™¨ overlay
- å®ç° Super é”®ç»‘å®šåˆ‡æ¢å¯åŠ¨å™¨
- Dockerfile æ·»åŠ  Chromium
- å®ç°åº”ç”¨æ³¨å†Œè¡¨å’Œå¯åŠ¨æµç¨‹
- æ›´æ–° init è„šæœ¬å¯åŠ¨æ¡Œé¢ç¯å¢ƒ

### Phase 5: æ‰“ç£¨

- çª—å£æœ€å°åŒ–/æœ€å¤§åŒ–
- KDP çª—å£æ‹–æ‹½ç§»åŠ¨ï¼ˆ`river_seat_v1.op_start_pointer`ï¼‰
- KDP çª—å£è°ƒæ•´å¤§å°
- å£çº¸å›¾ç‰‡æ¸²æŸ“ï¼ˆå®Œå–„ KDP image èŠ‚ç‚¹ï¼‰
- Agent ä¾§è¾¹æ é›†æˆï¼ˆç°æœ‰ agent_active 70% æ¨¡å¼ï¼‰

## 11. è®¾è®¡å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆç”¨ river_shell_surface è€Œé xdg_toplevel åŒ…è£… KDPï¼Ÿ

xdg_toplevel éœ€è¦åˆ›å»ºå®Œæ•´çš„ Wayland å®¢æˆ·ç«¯å¹¶èµ° xdg-shell åå•†æµç¨‹ï¼Œå¢åŠ å¤æ‚åº¦ã€‚WM å·²æœ‰ `river_shell_surface_v1` çš„ç‰¹æƒè®¿é—®ï¼Œå¯ç›´æ¥æ§åˆ¶ä½ç½®å’Œå±‚å é¡ºåºã€‚

### ä¸ºä»€ä¹ˆä¸ç”¨ waybar/swaybgï¼Ÿ

è¿™äº›å·¥å…·ä½¿ç”¨ `wlr-layer-shell`ï¼Œå¯è¡Œä½†å¼•å…¥å¤–éƒ¨è¿›ç¨‹ä¾èµ–ã€‚ç”¨ KDP æ¸²æŸ“é¢æ¿å’Œå£çº¸ï¼ŒAgent å¯ä»¥åŠ¨æ€ä¿®æ”¹å®ƒä»¬ï¼ˆå¦‚æ·»åŠ é€šçŸ¥ã€æ ¹æ®ä¸Šä¸‹æ–‡åˆ‡æ¢å£çº¸ï¼‰ï¼Œä¿æŒ Agent-Native å“²å­¦ã€‚

### ä¸ºä»€ä¹ˆä¿æŒåˆæˆå™¨ç«¯ KDP æ¸²æŸ“ï¼Ÿ

KDP çš„ä»·å€¼åœ¨äº Agent æ— éœ€å¯åŠ¨ç‹¬ç«‹è¿›ç¨‹å³å¯æ¸²æŸ“ UIã€‚åˆæˆå™¨ç«¯æ¸²æŸ“æ„å‘³ç€é›¶å»¶è¿Ÿæ˜¾ç¤ºæ›´æ–°ï¼ŒJSON UI æ ‘æ˜¯ IPC è¾¹ç•Œï¼Œå®é™…åƒç´ æ¸²æŸ“åœ¨åˆæˆå™¨æ¸²æŸ“å¾ªç¯ä¸­å®Œæˆã€‚
