<?xml version="1.0" encoding="UTF-8"?>
<protocol name="kairo_display_v1">
  <copyright>
    Copyright © 2025 Kairo Project
    SPDX-License-Identifier: MIT
  </copyright>

  <interface name="kairo_display_v1" version="2">
    <description summary="Kairo Display Protocol Manager">
      The global manager for Kairo Display Protocol.
      It allows clients (Kernel) to create surfaces for rendering UI trees.
    </description>

    <request name="get_kairo_surface">
      <description summary="create a kairo surface">
        Create a kairo_surface for a given wl_surface.
        The wl_surface will be used as the canvas for the UI tree.
      </description>
      <arg name="id" type="new_id" interface="kairo_surface_v1"/>
      <arg name="surface" type="object" interface="wl_surface"/>
    </request>
  </interface>

  <interface name="kairo_surface_v1" version="2">
    <description summary="Kairo Surface">
      A surface that renders a JSON-based UI tree.
      The client sends the UI tree as a string, and the compositor renders it.
    </description>

    <request name="commit_ui_tree">
      <description summary="update the UI tree">
        Send a new UI tree to be rendered on this surface.
        The tree is a JSON string.

        Supported node types:
        - root: 根节点容器
        - rect: 矩形（支持 radius 圆角、border 边框）
        - text: 文本（8x8 位图字体，支持 scale/font_size）
        - scroll: 滚动容器（scroll_height 内容高度，scroll_offset 偏移）
        - image: 图片节点（src 路径或 base64）
        - input: 输入框（value 当前值，placeholder 占位符）
        - clip: 裁剪容器（超出 width/height 的子节点被裁剪）
      </description>
      <arg name="json_payload" type="string" summary="Serialized UI Tree JSON"/>
    </request>

    <request name="destroy" type="destructor">
      <description summary="destroy the kairo surface">
        Destroy the kairo_surface object. The underlying wl_surface is not destroyed.
      </description>
    </request>

    <event name="user_action">
      <description summary="user interaction event">
        Emitted when the user interacts with the UI (e.g. click, input).
      </description>
      <arg name="element_id" type="string"/>
      <arg name="action_type" type="string" summary="click, submit, hover"/>
      <arg name="payload" type="string" summary="JSON data (e.g. input value)"/>
    </event>

    <event name="key_event">
      <description summary="keyboard input event">
        Emitted when a key is pressed or released while this surface has focus.
      </description>
      <arg name="key" type="uint" summary="Linux keycode"/>
      <arg name="state" type="uint" summary="0=released, 1=pressed"/>
      <arg name="modifiers" type="uint" summary="bitmask: 1=shift, 2=ctrl, 4=alt, 8=super"/>
    </event>

    <event name="pointer_event">
      <description summary="pointer motion and scroll event">
        Emitted when the pointer moves or scrolls over this surface.
      </description>
      <arg name="x" type="int" summary="pointer x relative to surface"/>
      <arg name="y" type="int" summary="pointer y relative to surface"/>
      <arg name="event_type" type="uint" summary="0=motion, 1=scroll_up, 2=scroll_down"/>
    </event>

    <event name="focus_event">
      <description summary="surface focus change">
        Emitted when this surface gains or loses keyboard focus.
      </description>
      <arg name="focused" type="uint" summary="1=gained focus, 0=lost focus"/>
    </event>

    <!-- KDP v2 扩展 -->

    <enum name="layer">
      <description summary="surface 的目标渲染层">
        控制 KDP surface 在合成器场景图中的渲染层级。
      </description>
      <entry name="wm" value="0" summary="窗口管理层（默认，参与 WM 布局和层叠）"/>
      <entry name="overlay" value="1" summary="覆盖层（始终置顶，如启动器）"/>
      <entry name="background" value="2" summary="背景层（壁纸）"/>
      <entry name="bottom" value="3" summary="底部层（任务栏）"/>
    </enum>

    <request name="set_layer" since="2">
      <description summary="设置 surface 的目标渲染层">
        设置此 surface 在合成器场景图中的渲染层。
        默认为 wm 层，参与窗口管理器的布局和层叠排序。
        必须在 commit_ui_tree 之前调用才能生效。
      </description>
      <arg name="layer" type="uint" enum="layer"/>
    </request>

    <request name="set_geometry" since="2">
      <description summary="设置 surface 几何信息">
        设置此 surface 的位置和尺寸。
        对于 wm 层的 surface，位置由窗口管理器通过 river_node_v1 控制，
        此请求仅用于通知合成器 surface 的逻辑尺寸。
        对于其他层（background/bottom/overlay），位置和尺寸直接生效。
      </description>
      <arg name="x" type="int"/>
      <arg name="y" type="int"/>
      <arg name="width" type="int"/>
      <arg name="height" type="int"/>
    </request>

    <request name="set_title" since="2">
      <description summary="设置窗口标题">
        设置此 surface 的标题，用于任务栏显示和窗口管理。
      </description>
      <arg name="title" type="string"/>
    </request>

    <event name="request_close" since="2">
      <description summary="合成器请求关闭窗口">
        合成器或窗口管理器请求客户端关闭此 surface。
        客户端应在处理完毕后调用 destroy 请求。
      </description>
    </event>
  </interface>
</protocol>
